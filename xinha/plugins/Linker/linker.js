Linker._pluginInfo={name:"Linker",version:"1.0",developer:"James Sleeman",developer_url:"http://www.gogo.co.nz/",c_owner:"Gogo Internet Services",license:"htmlArea",sponsor:"Gogo Internet Services",sponsor_url:"http://www.gogo.co.nz/"};Xinha.loadStyle("dTree/dtree.css","Linker");Xinha.Config.prototype.Linker={treeCaption:document.location.host,backend:_editor_url+"plugins/Linker/scan.php",backend_data:null,files:null};function Linker(b,a){this.editor=b;this.lConfig=b.config.Linker;var c=this;if(b.config.btnList.createlink){b.config.btnList.createlink[3]=function(f,g,d){c._createLink(c._getSelectedAnchor())}}else{b.config.registerButton("createlink","Insert/Modify Hyperlink",[_editor_url+"images/ed_buttons_main.gif",6,1],false,function(f,g,d){c._createLink(c._getSelectedAnchor())})}b.config.addToolbarElement("createlink","createlink",0)}Linker.prototype._lc=function(a){return Xinha._lc(a,"Linker")};Linker.prototype._createLink=function(n){if(!n&&this.editor.selectionEmpty(this.editor.getSelection())){alert(this._lc("You must select some text before making a new link."));return false}var k={type:"url",href:"http://www.example.com/",target:"",p_width:"",p_height:"",p_options:["menubar=no","toolbar=yes","location=no","status=no","scrollbars=yes","resizeable=yes"],to:"alice@example.com",subject:"",body:"",anchor:""};if(n&&n.tagName.toLowerCase()=="a"){var b=this.editor.fixRelativeLinks(n.getAttribute("href"));var c=b.match(/^mailto:(.*@[^?&]*)(\?(.*))?$/);var g=b.match(/^#(.*)$/);if(c){k.type="mailto";k.to=c[1];if(c[3]){var l=c[3].split("&");for(var o=0;o<l.length;o++){var e=l[o].match(/(subject|body)=(.*)/);if(e){k[e[1]]=decodeURIComponent(e[2])}}}}else{if(g){k.type="anchor";k.anchor=g[1]}else{if(n.getAttribute("onclick")){var c=n.getAttribute("onclick").match(/window\.open\(\s*this\.href\s*,\s*'([a-z0-9_]*)'\s*,\s*'([a-z0-9_=,]*)'\s*\)/i);k.href=b?b:"";k.target="popup";k.p_name=c[1];k.p_options=[];var l=c[2].split(",");for(var o=0;o<l.length;o++){var f=l[o].match(/(width|height)=([0-9]+)/);if(f){k["p_"+f[1]]=parseInt(f[2])}else{k.p_options.push(l[o])}}}else{k.href=b;k.target=n.target}}}}var h=this;this.a=n;var d=function(){var w=h.a;var x=h._dialog.hide();var v={href:"",target:"",title:"",onclick:""};if(x.type=="url"){if(x.href){v.href=x.href;v.target=x.target;if(x.target=="popup"){if(x.p_width){x.p_options.push("width="+x.p_width)}if(x.p_height){x.p_options.push("height="+x.p_height)}v.onclick="if(window.top && window.top.Xinha){return false}window.open(this.href, '"+(x.p_name.replace(/[^a-z0-9_]/i,"_"))+"', '"+x.p_options.join(",")+"');return false;"}}}else{if(x.type=="anchor"){if(x.anchor){v.href=x.anchor.value}}else{if(x.to){v.href="mailto:"+x.to;if(x.subject){v.href+="?subject="+encodeURIComponent(x.subject)}if(x.body){v.href+=(x.subject?"&":"?")+"body="+encodeURIComponent(x.body)}}}}if(w&&w.tagName.toLowerCase()=="a"){if(!v.href){if(confirm(h._dialog._lc("Are you sure you wish to remove this link?"))){var q=w.parentNode;while(w.hasChildNodes()){q.insertBefore(w.removeChild(w.childNodes[0]),w)}q.removeChild(w);h.editor.updateToolbar();return}}else{for(var s in v){w.setAttribute(s,v[s])}if(Xinha.is_ie){if(/mailto:([^?<>]*)(\?[^<]*)?$/i.test(w.innerHTML)){w.innerHTML=RegExp.$1}}}}else{if(!v.href){return true}var t=Xinha.uniq("http://www.example.com/Link");h.editor._doc.execCommand("createlink",false,t);var m=h.editor._doc.getElementsByTagName("a");for(var s=0;s<m.length;s++){var u=m[s];if(u.href==t){if(!w){w=u}for(var r in v){u.setAttribute(r,v[r])}}}}h.editor.selectNodeContents(w);h.editor.updateToolbar()};this._dialog.show(k,d)};Linker.prototype._getSelectedAnchor=function(){var d=this.editor.getSelection();var c=this.editor.createRange(d);var b=this.editor.activeElement(d);if(b!=null&&b.tagName.toLowerCase()=="a"){return b}else{b=this.editor._getFirstAncestor(d,"a");if(b!=null){return b}}return null};Linker.prototype.onGenerateOnce=function(){this._dialog=new Linker.Dialog(this)};Linker.Dialog_dTrees=[];Linker.Dialog=function(a){var b=this;this.Dialog_nxtid=0;this.linker=a;this.id={};this.ready=false;this.files=false;this.html=false;this.dialog=false;this._prepareDialog()};Linker.Dialog.prototype._prepareDialog=function(){var lDialog=this;var linker=this.linker;if(typeof dTree=="undefined"){Xinha._loadback(_editor_url+"plugins/Linker/dTree/dtree.js",function(){lDialog._prepareDialog()});return}if(this.files==false){if(linker.lConfig.backend){Xinha._postback(linker.lConfig.backend,linker.lConfig.backend_data,function(txt){try{lDialog.files=eval(txt)}catch(Error){lDialog.files=[{url:"",title:Error.toString()}]}lDialog._prepareDialog()})}else{if(linker.lConfig.files!=null){lDialog.files=linker.lConfig.files;lDialog._prepareDialog()}}return}var files=this.files;if(this.html==false){Xinha._getback(_editor_url+"plugins/Linker/dialog.html",function(txt){lDialog.html=txt;lDialog._prepareDialog()});return}var html=this.html;var dialog=this.dialog=new Xinha.Dialog(linker.editor,this.html,"Linker");var dTreeName=Xinha.uniq("dTree_");this.dTree=new dTree(dTreeName,_editor_url+"plugins/Linker/dTree/");eval(dTreeName+" = this.dTree");this.dTree.add(this.Dialog_nxtid++,-1,linker.lConfig.treeCaption,null,linker.lConfig.treeCaption);this.makeNodes(files,0);var ddTree=this.dialog.getElementById("dTree");ddTree.innerHTML="";ddTree.style.position="absolute";ddTree.style.left=1+"px";ddTree.style.top=0+"px";ddTree.style.overflow="auto";ddTree.style.backgroundColor="white";this.ddTree=ddTree;this.dTree._linker_premade=this.dTree.toString();var options=this.dialog.getElementById("options");options.style.position="absolute";options.style.top=0+"px";options.style.right=0+"px";options.style.width=320+"px";options.style.overflow="auto";this.dialog.onresize=function(){var h=parseInt(dialog.height)-dialog.getElementById("h1").offsetHeight;var w=parseInt(dialog.width)-322;if(w<0){w=0}if(h<0){h=0}options.style.height=ddTree.style.height=h+"px";ddTree.style.width=w+"px"};this.ready=true};Linker.Dialog.prototype.makeNodes=function(d,b){for(var a=0;a<d.length;a++){if(typeof d[a]=="string"){this.dTree.add(Linker.nxtid++,b,d[a].replace(/^.*\//,""),"javascript:document.getElementsByName('"+this.dialog.id.href+"')[0].value=decodeURIComponent('"+encodeURIComponent(d[a])+"');document.getElementsByName('"+this.dialog.id.type+"')[0].click();document.getElementsByName('"+this.dialog.id.href+"')[0].focus();void(0);",d[a])}else{if(d[a].length){var f=this.Dialog_nxtid++;this.dTree.add(f,b,d[a][0].replace(/^.*\//,""),null,d[a][0]);this.makeNodes(d[a][1],f)}else{if(typeof d[a]=="object"){if(d[a].children){var f=this.Dialog_nxtid++}else{var f=Linker.nxtid++}if(d[a].title){var e=d[a].title}else{if(d[a].url){var e=d[a].url.replace(/^.*\//,"")}else{var e="no title defined"}}if(d[a].url){var c="javascript:document.getElementsByName('"+this.dialog.id.href+"')[0].value=decodeURIComponent('"+encodeURIComponent(d[a].url)+"');document.getElementsByName('"+this.dialog.id.type+"')[0].click();document.getElementsByName('"+this.dialog.id.href+"')[0].focus();void(0);"}else{var c=""}this.dTree.add(f,b,e,c,e);if(d[a].children){this.makeNodes(d[a].children,f)}}}}}};Linker.Dialog.prototype._lc=Linker.prototype._lc;Linker.Dialog.prototype.show=function(j,l,o){if(!this.ready){var e=this;window.setTimeout(function(){e.show(j,l,o)},100);return}if(this.ddTree.innerHTML==""){this.ddTree.innerHTML=this.dTree._linker_premade}if(j.type=="url"){this.dialog.getElementById("urltable").style.display="";this.dialog.getElementById("mailtable").style.display="none";this.dialog.getElementById("anchortable").style.display="none"}else{if(j.type=="anchor"){this.dialog.getElementById("urltable").style.display="none";this.dialog.getElementById("mailtable").style.display="none";this.dialog.getElementById("anchortable").style.display=""}else{this.dialog.getElementById("urltable").style.display="none";this.dialog.getElementById("mailtable").style.display="";this.dialog.getElementById("anchortable").style.display="none"}}if(j.target=="popup"){this.dialog.getElementById("popuptable").style.display=""}else{this.dialog.getElementById("popuptable").style.display="none"}var g=this.dialog.getElementById("anchor");for(var f=g.length;f>=0;f--){g[f]=null}var h=this.linker.editor.getHTML();var a=new Array();var d=h.match(/<a[^>]+name="([^"]+)"/gi);if(d){for(f=0;f<d.length;f++){var c=d[f].match(/name="([^"]+)"/i);if(!a.contains(c[1])){a.push(c[1])}}}d=h.match(/id="([^"]+)"/gi);if(d){for(f=0;f<d.length;f++){c=d[f].match(/id="([^"]+)"/i);if(!a.contains(c[1])){a.push(c[1])}}}for(f=0;f<a.length;f++){var b=new Option(a[f],"#"+a[f],false,(j.anchor==a[f]));g[g.length]=b}if(g.length==0){this.dialog.getElementById("anchorfieldset").style.display="none"}if(j.href=="http://www.example.com/"&&j.to=="alice@example.com"){this.dialog.getElementById("clear").style.display="none"}else{this.dialog.getElementById("clear").style.display=""}var k=this.dialog;var e=this;if(l){this.dialog.getElementById("ok").onclick=l}else{this.dialog.getElementById("ok").onclick=function(){e.hide()}}if(o){this.dialog.getElementById("cancel").onclick=o}else{this.dialog.getElementById("cancel").onclick=function(){e.hide()}}this.linker.editor.disableToolbar(["fullscreen","linker"]);this.dialog.show(j);this.dialog.onresize()};Linker.Dialog.prototype.hide=function(){this.linker.editor.enableToolbar();return this.dialog.hide()};